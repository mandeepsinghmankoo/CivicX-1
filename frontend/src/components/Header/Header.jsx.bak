import { Container, Logo, Logout } from '../Index';
import { Link, useNavigate } from 'react-router-dom';
import { useSelector } from 'react-redux';
import { Bell, Menu, X } from "lucide-react";
import { useState, useRef, useEffect } from 'react';



function Header() {function Header() {

  const navigate = useNavigate();  const navigate = useNavigate();

  const authStatus = useSelector((state) => state.auth.status);  const authStatus = useSelector((state) => state.auth.status);

  const userData = useSelector((state) => state.auth.userData);  const userData = useSelector((state) => state.auth.userData);

  const computedRole = (userData?.role || userData?.profile?.role || 'citizen');  const computedRole = (userData?.role || userData?.profile?.role || 'citizen');

  const userRole = typeof computedRole === 'string' ? computedRole.toLowerCase() : 'citizen';  const userRole = typeof computedRole === 'string' ? computedRole.toLowerCase() : 'citizen';

  const [menuOpen, setMenuOpen] = useState(false);  const [menuOpen, setMenuOpen] = useState(false);

  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  const menuRef = useRef(null);  const menuRef = useRef(null);

  // Real-time Appwrite subscription for issues

  // Notification state  useEffect(() => {

  const [notifications, setNotifications] = useState([]);    let unsubscribe;

  const [showNotif, setShowNotif] = useState(false);    import("../../appwrite/config").then(({ default: configService }) => {

      unsubscribe = configService.subscribeToIssueEvents((payload) => {

  // Real-time Appwrite subscription for issues        const events = payload?.$events || [];

  useEffect(() => {        const isCreate = events.some(e => e.endsWith(".create"));

    let unsubscribe;        const isUpdate = events.some(e => e.endsWith(".update"));

    import("../../appwrite/config").then(({ default: configService }) => {        if (isCreate) {

      unsubscribe = configService.subscribeToIssueEvents((payload) => {          setNotifications(prev => [

        const events = payload?.$events || [];            {

        const isCreate = events.some(e => e.endsWith(".create"));              id: Date.now() + Math.random(),

        const isUpdate = events.some(e => e.endsWith(".update"));              type: "new_issue",

        if (isCreate) {              message: `New issue reported: ${payload.title}`,

          setNotifications(prev => [              link: `/issue/${payload.$id}`,

            {              read: false,

              id: Date.now() + Math.random(),              date: new Date().toLocaleDateString()

              type: "new_issue",            },

              message: `New issue reported: ${payload.title}`,            ...prev

              link: `/issue/${payload.$id}`,          ]);

              read: false,        }

              date: new Date().toLocaleDateString()        if (isUpdate) {

            },          setNotifications(prev => [

            ...prev            {

          ]);              id: Date.now() + Math.random(),

        }              type: "status_change",

        if (isUpdate) {              message: `Issue '${payload.title}' status changed to ${payload.status}`,

          setNotifications(prev => [              link: `/issue/${payload.$id}`,

            {              read: false,

              id: Date.now() + Math.random(),              date: new Date().toLocaleDateString()

              type: "status_change",            },

              message: `Issue '${payload.title}' status changed to ${payload.status}`,            ...prev

              link: `/issue/${payload.$id}`,          ]);

              read: false,        }

              date: new Date().toLocaleDateString()      });

            },    });

            ...prev    return () => {

          ]);      if (unsubscribe) unsubscribe();

        }    };

      });  }, []);

    });

    return () => {  // Mark notification as read and navigate

      if (unsubscribe) unsubscribe();  const handleNotifClick = (id, link) => {

    };    setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));

  }, []);    navigate(link);

    setShowNotif(false);

  // Mark notification as read and navigate  };

  const handleNotifClick = (id, link) => {import { Container, Logo, Logout } from '../Index';

    setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));import { Link, useNavigate } from 'react-router-dom';

    navigate(link);import { useSelector } from 'react-redux';

    setShowNotif(false);import { Bell, Menu, X } from "lucide-react";

  };import { useState, useRef, useEffect } from 'react';



  // Close dropdown when clicking outside

  useEffect(() => {function Header() {

    function handleClickOutside(event) {  const navigate = useNavigate()

      if (menuRef.current && !menuRef.current.contains(event.target)) {  const authStatus = useSelector((state) => state.auth.status)

        setMenuOpen(false);  const userData = useSelector((state) => state.auth.userData)

      }  const computedRole = (userData?.role || userData?.profile?.role || 'citizen')

    }  const userRole = typeof computedRole === 'string' ? computedRole.toLowerCase() : 'citizen'

    document.addEventListener("mousedown", handleClickOutside);  const [menuOpen, setMenuOpen] = useState(false);

    return () => document.removeEventListener("mousedown", handleClickOutside);  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  }, []);  const menuRef = useRef(null);



  // Close mobile menu when window is resized to desktop  // Close dropdown when clicking outside

  useEffect(() => {  useEffect(() => {

    const handleResize = () => {    // ...existing code...

      if (window.innerWidth >= 768) {              )

        setMobileMenuOpen(false);            }

      }            {/* Notification Bell */}

    };            {authStatus && (

    window.addEventListener('resize', handleResize);              <li className="relative">

    return () => window.removeEventListener('resize', handleResize);                <button

  }, []);                  onClick={() => setShowNotif(!showNotif)}

                  className="relative text-green-100 hover:text-white transition-colors"

  const navItems = [                >

    { name: 'Home', slug: '/', active: true },                  <Bell size={22} />

    { name: 'About', slug: '/about', active: true },                  {notifications.filter(n => !n.read).length > 0 && (

    { name: 'Live Issue', slug: '/liveissues', active: authStatus },                    <span className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full px-2 py-0.5 text-xs font-bold">{notifications.filter(n => !n.read).length}</span>

    { name: 'My Issues', slug: '/my-issues', active: authStatus && userRole === 'citizen' },                  )}

    { name: 'Manage Issues', slug: '/manage-issues', active: authStatus && userRole === 'official' },                </button>

    { name: 'LogIn', slug: '/login', active: !authStatus },                {/* Notification Dropdown */}

    { name: 'SignUp', slug: '/signup', active: !authStatus },                {showNotif && (

  ];                  <div className="absolute right-0 mt-2 w-80 bg-[#1a1a1a] shadow-lg rounded-xl overflow-hidden z-50 border border-gray-700">

                    <div className="p-4 border-b border-gray-700 font-bold text-[#045c65]">Notifications</div>

  const avatarInitial = (() => {                    <div className="max-h-64 overflow-y-auto">

    const source = (userData?.name || userData?.profile?.name || userData?.email || 'User').trim();                      {notifications.length === 0 ? (

    return source ? source.charAt(0).toUpperCase() : 'U';                        <div className="p-4 text-gray-400">No notifications</div>

  })();                      ) : (

                        notifications.map(n => (

  return (                          <button

    <header className='py-3 shadow-2xl text-green-100 px-4 md:px-30'>                            key={n.id}

      <Container>                            onClick={() => handleNotifClick(n.id, n.link)}

        <nav className='flex items-center justify-between'>                            className={`block w-full text-left px-4 py-3 border-b border-gray-700 ${n.read ? "bg-[#222] text-gray-400" : "bg-[#045c65] text-white"} hover:bg-[#067a85] transition-colors`}

          <div className='mr-4'>                          >

            <Link to='/'>                            <div className="flex justify-between items-center">

              <Logo />                              <span>{n.message}</span>

            </Link>                              <span className="ml-2 text-xs">{n.date}</span>

          </div>                            </div>

                          </button>

          {/* Desktop Navigation */}                        ))

          <ul className='hidden md:flex ml-auto gap-6 lg:gap-8 items-center'>                      )}

            {navItems.map((item, i) =>                    </div>

              item.active ? (                  </div>

                <li key={i}>                )}

                  <button              </li>

                    onClick={() => navigate(item.slug)}            )}

                    className='text-green-100 text-sm lg:text-lg font-semibold transition-all duration-300 hover:scale-105 flex items-center'

                  >            {/* Profile Dropdown (only when logged in) */}

                    {item.icon ? item.icon : item.name}            {authStatus && (

                  </button>              <li className="relative" ref={menuRef}>

                </li>                <button

              ) : null                  onClick={() => setMenuOpen(!menuOpen)}

            )}                  className="w-10 h-10 rounded-full bg-[#045c65] flex items-center justify-center text-white font-bold hover:scale-105 transition hover:bg-[#067a85]"

                >

            {/* Notification Bell */}                  {avatarInitial}

            {authStatus && (                </button>

              <li className="relative">

                <button                {menuOpen && (

                  onClick={() => setShowNotif(!showNotif)}                  <div className="absolute right-0 mt-2 w-40 bg-[#1a1a1a] shadow-lg rounded-xl overflow-hidden z-50 border border-gray-700">

                  className="relative text-green-100 hover:text-white transition-colors"                    <button

                >                      onClick={() => navigate("/profile")}

                  <Bell size={22} />                      className="block w-full text-left px-4 py-2 text-white hover:bg-[#045c65] transition-colors"

                  {notifications.filter(n => !n.read).length > 0 && (                    >

                    <span className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full px-2 py-0.5 text-xs font-bold">                      My Profile

                      {notifications.filter(n => !n.read).length}                    </button>

                    </span>                    <button

                  )}                      onClick={() => navigate("/settings")}

                </button>                      className="block w-full text-left px-4 py-2 text-white hover:bg-[#045c65] transition-colors"

                {/* Notification Dropdown */}                    >

                {showNotif && (                      Settings

                  <div className="absolute right-0 mt-2 w-80 bg-[#1a1a1a] shadow-lg rounded-xl overflow-hidden z-50 border border-gray-700">                    </button>

                    <div className="p-4 border-b border-gray-700 font-bold text-[#045c65]">Notifications</div>                    <Logout />

                    <div className="max-h-64 overflow-y-auto">                  </div>

                      {notifications.length === 0 ? (                )}

                        <div className="p-4 text-gray-400">No notifications</div>              </li>

                      ) : (            )}

                        notifications.map(n => (          </ul>

                          <button

                            key={n.id}          {/* Mobile Menu Button */}

                            onClick={() => handleNotifClick(n.id, n.link)}          <button

                            className={`block w-full text-left px-4 py-3 border-b border-gray-700 ${            onClick={() => setMobileMenuOpen(!mobileMenuOpen)}

                              n.read ? "bg-[#222] text-gray-400" : "bg-[#045c65] text-white"            className="md:hidden p-2 text-green-100 hover:text-white transition-colors"

                            } hover:bg-[#067a85] transition-colors`}          >

                          >            {mobileMenuOpen ? <X size={24} /> : <Menu size={24} />}

                            <div className="flex justify-between items-center">          </button>

                              <span>{n.message}</span>        </nav>

                              <span className="ml-2 text-xs">{n.date}</span>

                            </div>        {/* Mobile Navigation Menu */}

                          </button>        {mobileMenuOpen && (

                        ))          <div className="md:hidden mt-4 pb-4 border-t border-gray-700">

                      )}            <ul className='flex flex-col gap-4 pt-4'>

                    </div>              {

                  </div>                navItems.map((item, i) =>

                )}                  item.active ? (

              </li>                    <li key={i}>

            )}                      <button

                        onClick={() => {

            {/* Profile Dropdown */}                          navigate(item.slug);

            {authStatus && (                          setMobileMenuOpen(false);

              <li className="relative" ref={menuRef}>                        }}

                <button                        className='text-green-100 text-lg font-semibold transition-all duration-300 hover:scale-105 flex items-center w-full text-left'

                  onClick={() => setMenuOpen(!menuOpen)}                      >

                  className="w-10 h-10 rounded-full bg-[#045c65] flex items-center justify-center text-white font-bold hover:scale-105 transition hover:bg-[#067a85]"                        {item.icon ? item.icon : item.name}

                >                      </button>

                  {avatarInitial}                    </li>

                </button>                  ) : null

                {menuOpen && (                )

                  <div className="absolute right-0 mt-2 w-40 bg-[#1a1a1a] shadow-lg rounded-xl overflow-hidden z-50 border border-gray-700">              }

                    <button

                      onClick={() => navigate("/profile")}              {/* Mobile Profile Section */}

                      className="block w-full text-left px-4 py-2 text-white hover:bg-[#045c65] transition-colors"              {authStatus && (

                    >                <li className="pt-4 border-t border-gray-700">

                      My Profile                  <div className="flex items-center gap-3 mb-3">

                    </button>                    <div className="w-10 h-10 rounded-full bg-[#045c65] flex items-center justify-center text-white font-bold">

                    <button                      {avatarInitial}

                      onClick={() => navigate("/settings")}                    </div>

                      className="block w-full text-left px-4 py-2 text-white hover:bg-[#045c65] transition-colors"                    <span className="text-green-100 font-semibold">

                    >                      {userData?.name || userData?.profile?.name || 'User'}

                      Settings                    </span>

                    </button>                  </div>

                    <Logout />                  <div className="flex flex-col gap-2">

                  </div>                    <button

                )}                      onClick={() => {

              </li>                        navigate("/profile");

            )}                        setMobileMenuOpen(false);

          </ul>                      }}

                      className="text-green-100 text-lg hover:text-white transition-colors text-left"

          {/* Mobile Menu Button */}                    >

          <button                      My Profile

            onClick={() => setMobileMenuOpen(!mobileMenuOpen)}                    </button>

            className="md:hidden p-2 text-green-100 hover:text-white transition-colors"                    <button

          >                      onClick={() => {

            {mobileMenuOpen ? <X size={24} /> : <Menu size={24} />}                        navigate("/settings");

          </button>                        setMobileMenuOpen(false);

        </nav>                      }}

                      className="text-green-100 text-lg hover:text-white transition-colors text-left"

        {/* Mobile Navigation Menu */}                    >

        {mobileMenuOpen && (                      Settings

          <div className="md:hidden mt-4 pb-4 border-t border-gray-700">                    </button>

            <ul className='flex flex-col gap-4 pt-4'>                    <div onClick={() => setMobileMenuOpen(false)}>

              {navItems.map((item, i) =>                      <Logout />

                item.active ? (                    </div>

                  <li key={i}>                  </div>

                    <button                </li>

                      onClick={() => {              )}

                        navigate(item.slug);            </ul>

                        setMobileMenuOpen(false);          </div>

                      }}        )}

                      className='text-green-100 text-lg font-semibold transition-all duration-300 hover:scale-105 flex items-center w-full text-left'      </Container>

                    >    </header>

                      {item.icon ? item.icon : item.name}  );

                    </button>          <div className='mr-4'>

                  </li>            <Link to='/'>

                ) : null              <Logo />

              )}            </Link>

          </div>

              {/* Mobile Profile Section */}

              {authStatus && (          {/* Desktop Navigation */}

                <li className="pt-4 border-t border-gray-700">          <ul className='hidden md:flex ml-auto gap-6 lg:gap-8 items-center'>

                  <div className="flex items-center gap-3 mb-3">            {

                    <div className="w-10 h-10 rounded-full bg-[#045c65] flex items-center justify-center text-white font-bold">              navItems.map((item, i) =>

                      {avatarInitial}                item.active ? (

                    </div>                  <li key={i}>

                    <span className="text-green-100 font-semibold">                    <button

                      {userData?.name || userData?.profile?.name || 'User'}                      onClick={() => navigate(item.slug)}

                    </span>                      className='text-green-100 text-sm lg:text-lg font-semibold transition-all duration-300 hover:scale-105 flex items-center'

                  </div>                    >

                  <div className="flex flex-col gap-2">                      {item.icon ? item.icon : item.name}

                    <button                    </button>

                      onClick={() => {                  </li>

                        navigate("/profile");                ) : null

                        setMobileMenuOpen(false);              )

                      }}            }

                      className="text-green-100 text-lg hover:text-white transition-colors text-left"            {/* Notification Bell */}

                    >            {authStatus && (

                      My Profile              <li className="relative">

                    </button>                <button

                    <button                  onClick={() => setShowNotif(!showNotif)}

                      onClick={() => {                  className="relative text-green-100 hover:text-white transition-colors"

                        navigate("/settings");                >

                        setMobileMenuOpen(false);                  <Bell size={22} />

                      }}                  {notifications.filter(n => !n.read).length > 0 && (

                      className="text-green-100 text-lg hover:text-white transition-colors text-left"                    <span className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full px-2 py-0.5 text-xs font-bold">{notifications.filter(n => !n.read).length}</span>

                    >                  )}

                      Settings                </button>

                    </button>                {/* Notification Dropdown */}

                    <div onClick={() => setMobileMenuOpen(false)}>                {showNotif && (

                      <Logout />                  <div className="absolute right-0 mt-2 w-80 bg-[#1a1a1a] shadow-lg rounded-xl overflow-hidden z-50 border border-gray-700">

                    </div>                    <div className="p-4 border-b border-gray-700 font-bold text-[#045c65]">Notifications</div>

                  </div>                    <div className="max-h-64 overflow-y-auto">

                </li>                      {notifications.length === 0 ? (

              )}                        <div className="p-4 text-gray-400">No notifications</div>

            </ul>                      ) : (

          </div>                        notifications.map(n => (

        )}                          <button

      </Container>                            key={n.id}

    </header>                            onClick={() => handleNotifClick(n.id, n.link)}

  );                            className={`block w-full text-left px-4 py-3 border-b border-gray-700 ${n.read ? "bg-[#222] text-gray-400" : "bg-[#045c65] text-white"} hover:bg-[#067a85] transition-colors`}

}                          >

                            <div className="flex justify-between items-center">

export default Header;                              <span>{n.message}</span>
                              <span className="ml-2 text-xs">{n.date}</span>
                            </div>
                          </button>
                        ))
                      )}
                    </div>
                  </div>
                )}
              </li>
            )}

            {/* Profile Dropdown (only when logged in) */}
            {authStatus && (
              <li className="relative" ref={menuRef}>
                <button
                  onClick={() => setMenuOpen(!menuOpen)}
                  className="w-10 h-10 rounded-full bg-[#045c65] flex items-center justify-center text-white font-bold hover:scale-105 transition hover:bg-[#067a85]"
                >
                  {avatarInitial}
                </button>

                {menuOpen && (
                  <div className="absolute right-0 mt-2 w-40 bg-[#1a1a1a] shadow-lg rounded-xl overflow-hidden z-50 border border-gray-700">
                    <button
                      onClick={() => navigate("/profile")}
                      className="block w-full text-left px-4 py-2 text-white hover:bg-[#045c65] transition-colors"
                    >
                      My Profile
                    </button>
                    <button
                      onClick={() => navigate("/settings")}
                      className="block w-full text-left px-4 py-2 text-white hover:bg-[#045c65] transition-colors"
                    >
                      Settings
                    </button>
                    
                      <Logout />
                    
                  </div>
                )}
              </li>
            )}
          </ul>

          {/* Mobile Menu Button */}
          <button
            onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
            className="md:hidden p-2 text-green-100 hover:text-white transition-colors"
          >
            {mobileMenuOpen ? <X size={24} /> : <Menu size={24} />}
          </button>
        </nav>

        {/* Mobile Navigation Menu */}
        {mobileMenuOpen && (
          <div className="md:hidden mt-4 pb-4 border-t border-gray-700">
            <ul className='flex flex-col gap-4 pt-4'>
              {
                navItems.map((item, i) =>
                  item.active ? (
                    <li key={i}>
                      <button
                        onClick={() => {
                          navigate(item.slug);
                          setMobileMenuOpen(false);
                        }}
                        className='text-green-100 text-lg font-semibold transition-all duration-300 hover:scale-105 flex items-center w-full text-left'
                      >
                        {item.icon ? item.icon : item.name}
                      </button>
                    </li>
                  ) : null
                )
              }

              {/* Mobile Profile Section */}
              {authStatus && (
                <li className="pt-4 border-t border-gray-700">
                  <div className="flex items-center gap-3 mb-3">
                    <div className="w-10 h-10 rounded-full bg-[#045c65] flex items-center justify-center text-white font-bold">
                      {avatarInitial}
                    </div>
                    <span className="text-green-100 font-semibold">
                      {userData?.name || userData?.profile?.name || 'User'}
                    </span>
                  </div>
                  <div className="flex flex-col gap-2">
                    <button
                      onClick={() => {
                        navigate("/profile");
                        setMobileMenuOpen(false);
                      }}
                      className="text-green-100 text-lg hover:text-white transition-colors text-left"
                    >
                      My Profile
                    </button>
                    <button
                      onClick={() => {
                        navigate("/settings");
                        setMobileMenuOpen(false);
                      }}
                      className="text-green-100 text-lg hover:text-white transition-colors text-left"
                    >
                      Settings
                    </button>
                    <div onClick={() => setMobileMenuOpen(false)}>
                      <Logout />
                    </div>
                  </div>
                </li>
              )}
            </ul>
          </div>
        )}
      </Container>
    </header>
  )
}

export default Header
